<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>尝试还原VirtualDom | 守夜人笔记</title>
    <meta name="description" content="守夜人笔记">
    <meta name="generator" content="VuePress 1.3.1">
    <link rel="icon" href="/img/favicon.ico">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.f09e5b7a.css" as="style"><link rel="preload" href="/assets/js/app.903983bb.js" as="script"><link rel="preload" href="/assets/js/2.c5c844f9.js" as="script"><link rel="preload" href="/assets/js/7.b152462c.js" as="script"><link rel="prefetch" href="/assets/js/10.acc61093.js"><link rel="prefetch" href="/assets/js/11.b5b7d313.js"><link rel="prefetch" href="/assets/js/12.044e77b3.js"><link rel="prefetch" href="/assets/js/13.f84ff47d.js"><link rel="prefetch" href="/assets/js/14.4f25373e.js"><link rel="prefetch" href="/assets/js/15.69ad7253.js"><link rel="prefetch" href="/assets/js/16.ac264240.js"><link rel="prefetch" href="/assets/js/17.8684da05.js"><link rel="prefetch" href="/assets/js/18.ceef7e7d.js"><link rel="prefetch" href="/assets/js/19.fdccf963.js"><link rel="prefetch" href="/assets/js/20.eea2ef94.js"><link rel="prefetch" href="/assets/js/21.436a904b.js"><link rel="prefetch" href="/assets/js/22.5b0e4632.js"><link rel="prefetch" href="/assets/js/23.456132eb.js"><link rel="prefetch" href="/assets/js/24.0c9dfbdb.js"><link rel="prefetch" href="/assets/js/25.1e46f166.js"><link rel="prefetch" href="/assets/js/26.bc6d72fe.js"><link rel="prefetch" href="/assets/js/27.699fbdd0.js"><link rel="prefetch" href="/assets/js/28.b4423e59.js"><link rel="prefetch" href="/assets/js/3.b94df1a7.js"><link rel="prefetch" href="/assets/js/4.29bcc168.js"><link rel="prefetch" href="/assets/js/5.a332531e.js"><link rel="prefetch" href="/assets/js/6.a34f260f.js"><link rel="prefetch" href="/assets/js/8.6811b85d.js"><link rel="prefetch" href="/assets/js/9.a9a41e29.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f09e5b7a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">守夜人笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  home
</a></div><div class="nav-item"><a href="/FAQ/" class="nav-link router-link-active">
  求索
</a></div><div class="nav-item"><a href="/Thought/" class="nav-link">
  随笔
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/StackFei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub首页
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  home
</a></div><div class="nav-item"><a href="/FAQ/" class="nav-link router-link-active">
  求索
</a></div><div class="nav-item"><a href="/Thought/" class="nav-link">
  随笔
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/StackFei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub首页
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/FAQ/" class="sidebar-link">📚JS手残</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>花里胡哨必备点</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/FAQ/ES/promise.html" class="sidebar-link">🚗promise</a></li><li><a href="/FAQ/ES/react-window.html" class="sidebar-link">🚕长列表</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>React中的一些小心得</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/FAQ/React/VirtualDom.html" class="active sidebar-link">🌰简单的虚拟Dom</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/FAQ/React/VirtualDom.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/FAQ/React/VirtualDom.html#分析结构" class="sidebar-link">分析结构</a></li><li class="sidebar-sub-header"><a href="/FAQ/React/VirtualDom.html#index入口代码结构" class="sidebar-link">index入口代码结构</a></li><li class="sidebar-sub-header"><a href="/FAQ/React/VirtualDom.html#element虚拟dom的前世今生" class="sidebar-link">element虚拟dom的前世今生</a></li><li class="sidebar-sub-header"><a href="/FAQ/React/VirtualDom.html#element计算补丁包的神奇diff" class="sidebar-link">element计算补丁包的神奇diff</a></li><li class="sidebar-sub-header"><a href="/FAQ/React/VirtualDom.html#element替换节点的工匠patch" class="sidebar-link">element替换节点的工匠patch</a></li></ul></li><li><a href="/FAQ/React/react-router.html" class="sidebar-link">🍑router</a></li><li><a href="/FAQ/React/context.html" class="sidebar-link">🍇上下文</a></li><li><a href="/FAQ/React/react-redux.html" class="sidebar-link">🍎redux的通讯方式</a></li><li><a href="/FAQ/React/react-redux-middleware.html" class="sidebar-link">🍍简易中间件</a></li><li><a href="/FAQ/React/Hooks.html" class="sidebar-link">🍊Hooks</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue的一些小笔记</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/FAQ/Vue/Cli.html" class="sidebar-link">🔨花里胡哨的cli</a></li><li><a href="/FAQ/Vue/observer.html" class="sidebar-link">🔧乞丐版本MvvM</a></li><li><a href="/FAQ/Vue/Communication.html" class="sidebar-link">🛠️记一次通信方式</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>日常杂玩</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/FAQ/Work/TSC.html" class="sidebar-link">🏋️‍♂️TypeScript</a></li><li><a href="/FAQ/Work/cicd.html" class="sidebar-link">🚴持续集成部署（ci/cd）</a></li><li><a href="/FAQ/Work/AOP.html" class="sidebar-link">🏌️‍♂️AOP面向切片编程</a></li><li><a href="/FAQ/Work/WeChat.html" class="sidebar-link">⛹️踩坑React系列小程序</a></li><li><a href="/FAQ/Work/Work1.html" class="sidebar-link">🤾‍♂️前端请求的正确打开方式</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>乱写系列</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/FAQ/Node/require.html" class="sidebar-link">🏀require基操</a></li><li><a href="/FAQ/Node/Koa.html" class="sidebar-link">⚽️初级Koa</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><blockquote><p>高仿<code>React</code>的虚拟dom,外加冒牌的<code>diff</code>算法</p></blockquote> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>前端世界，框架横行。稍不留神，就会被技术淘汰，当然据小编所知，业界的巨头也只有其三。大家熟知的<code>Vue</code>由尤大神组队开发开源，可谓是国人的骄傲，<code>React</code>由Facebook团队维护，<code>Ng</code>大家都懂，国内市场份额较少，就不做多介绍。当然框架产出的原因，无非是利于管理，对于开发性能而言，其实是无多大用处的，借用尤大神的说法<code>只是在好管理项目的基础上提供还算不错的性能</code>。既然有这么大的框架，必须得有较为优秀的算法支撑，这次，咱们就研究研究，其高性能的背后支柱之一，虚拟Dom。</p> <h2 id="分析结构"><a href="#分析结构" class="header-anchor">#</a> 分析结构</h2> <p>通过虚拟Dom这个方法，产出一个Dom节点，首先分析一下HTML元素<code>&lt;div class=&quot;container&quot;&gt;&lt;p class=&quot;text&quot;&gt;text&lt;/p&gt;&lt;/div&gt;</code>,由节点名称，节点属性，节点子孙组成，多层嵌套，无非就是加上<code>children</code>来递归实现。结构较为清晰，我给你一个对象，你返回一个Dom节点。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> VertualDom <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;ul&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&quot;list&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&quot;itme&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&quot;itme&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&quot;itme&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>由一个一个对象构成，这样创建节点的函数明确了，当然仅仅这样是没有什么卵用的，我得改变页面，通过数据来驱动页面，这也是框架的精髓。先上来结构图分析一下。</p> <div class="language- extra-class"><pre class="language-text"><code>── src
   ├── index   // 入口
   ├── element // 创建节点
   ├── patch   // 记录补丁包 
   └── diff    // 简单的算法修改补丁包
</code></pre></div><p>明确需求：通过<code>element</code>创建一个dom节点，修改数据调用<code>patch</code>来记录修改的数据,以此修改界面，但这样频繁的修改很耗性能，<code>diff</code>排上用场了，用最小的遍历角度优化修改补丁包，当然这是乞丐版的。源码可不止这样草率。</p> <h2 id="index入口代码结构"><a href="#index入口代码结构" class="header-anchor">#</a> index入口代码结构</h2> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// index.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createElement<span class="token punctuation">,</span> render<span class="token punctuation">,</span> renderDom <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./element'</span>
<span class="token keyword">let</span> VertualDom <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;ul&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&quot;list&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&quot;itme&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&quot;itme&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&quot;itme&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> el <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span>VertualDom<span class="token punctuation">)</span>
</code></pre></div><p>需求明确，需要<code>createElement</code>创建虚拟节点,<code>render</code>将创建的虚拟节点转换为真实<code>dom</code>元素,<code>renderDom</code>将转换后的真实<code>dom</code>挂载到<code>html</code>元素上</p> <h2 id="element虚拟dom的前世今生"><a href="#element虚拟dom的前世今生" class="header-anchor">#</a> element虚拟dom的前世今生</h2> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// element.js</span>
<span class="token keyword">class</span> <span class="token class-name">Element</span> <span class="token punctuation">{</span> <span class="token comment">// 通过 Element 类方法批量创建</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> props<span class="token punctuation">,</span> children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> type
        <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props
        <span class="token keyword">this</span><span class="token punctuation">.</span>children <span class="token operator">=</span> children
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//返回虚拟节点的object</span>
<span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> props<span class="token punctuation">,</span> children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> props<span class="token punctuation">,</span> children<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><p>此时的虚拟dom已经创建出来，不出所料会是一个<code>html</code>节点对象,回到<code>index.js</code>将其打印出来瞅瞅,</p> <p><img src="/assets/img/react1.37bec28f.png" alt="react虚拟dom"></p> <p>是他没错了，<code>type</code>代表类型,<code>prop</code>代表传入的各种属性,比如<code>class</code>，<code>id</code>啥的,<code>children</code>代表其子元素，或者文本元素,单光是这样是不够的，无法在浏览器中显示，这时候就需要<code>render</code>函数来转换节点了,回到<code>element.js</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// element.js</span>
<span class="token comment">//render将virtual node转化为真实dom</span>
<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">eleObj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>eleObj<span class="token punctuation">.</span>type<span class="token punctuation">)</span>
    <span class="token comment">//遍历children dom继续渲染 or 渲染文本</span>
    eleObj<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        child <span class="token operator">=</span> <span class="token punctuation">(</span>child <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">render</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span> <span class="token operator">:</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
        el<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> el<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>解释一下,结构一目了然，创建传入的节点元素属性并创建出来，可能<code>children</code>存在多层，ok，遍历。当然<code>children</code>也可能不是<code>dom</code>节点，可能只是单纯的文字元素,这时候就需要做一点容错。当然创建节点不止如此，还要给节点添加传入的各种属性，这点稍后会说到。这时候，再回到<code>index.js</code>将其打印出来瞅瞅,看看dom节点长啥样</p> <p><img src="data:image/png;base64,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" alt="react虚拟dom"></p> <p>唉，有点样子了!但是总感觉少点什么，没错，得把属性加上去啊前端可就是靠样式吃饭的。那咱就写一个添加属性的方法上去，先明确需求，属性在普通标签<code>div</code>等等等可以直接添加上去比如<code>style</code>,<code>class</code>，但<code>input</code>，等文本标签的属性<code>value</code>等啊，就得另做处理。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// element.js</span>
<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">eleObj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>eleObj<span class="token punctuation">.</span>type<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> eleObj<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//设置属性的方法</span>
        <span class="token function">setAttr</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> key<span class="token punctuation">,</span> eleObj<span class="token punctuation">.</span>props<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
<span class="token comment">//节点设置属性</span>
<span class="token keyword">function</span> <span class="token function">setAttr</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token string">&quot;value&quot;</span><span class="token operator">:</span> <span class="token comment">//node节点是input或者textarea</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>tagName<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;INPUT&quot;</span> <span class="token operator">||</span> node<span class="token punctuation">.</span>tagName<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;TEXTAREA&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                node<span class="token punctuation">.</span>value <span class="token operator">=</span> value
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                node<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">&quot;style&quot;</span><span class="token operator">:</span> <span class="token comment">//设置样式</span>
            node<span class="token punctuation">.</span>style<span class="token punctuation">.</span>cssText <span class="token operator">=</span> value
        <span class="token keyword">default</span><span class="token operator">:</span>
            node<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>分析功能，在创建完节点之后，咱们循环给节点添加属性，穿入当前元素<code>el</code>,当前第多少个要添加<code>key</code>，以及当前第多少个要添加的属性值<code>value</code>,掠一下，其实也不是很难,这里设置节点的时候，得用<code>switch</code>来穿透循环多个，可能有的节点同时拥有<code>style</code>,<code>class</code>等多个属性,最容易被忽略掉的就是输入框，他的属性值<code>value</code>容易被写掉，所以得专门抽出来，再来<code>index.js</code>看看打印结果</p> <p><img src="data:image/png;base64,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" alt="react虚拟dom"></p> <p>有点雏形了，接下来是最为重要的一步之一，将<code>dom</code>元素，挂载到<code>html</code>文档中，这个相对而言，就简单很多了直接上代码,看结果。当然你得在html文档中有一个可挂载的节点，并且<code>id</code>为<code>root</code>才行</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// element.js</span>
<span class="token comment">//渲染页面</span>
<span class="token keyword">function</span> <span class="token function">renderDom</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">//index.js</span>
<span class="token operator">...</span>
<span class="token keyword">let</span> el <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span>VertualDom<span class="token punctuation">)</span>
<span class="token function">renderDom</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> window<span class="token punctuation">.</span>root<span class="token punctuation">)</span>
</code></pre></div><p><img src="data:image/png;base64,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" alt="react虚拟dom"></p> <p>感觉离成功又近了一步，有没有，当然代码却不止如此，要不那多磕碜。</p> <h2 id="element计算补丁包的神奇diff"><a href="#element计算补丁包的神奇diff" class="header-anchor">#</a> element计算补丁包的神奇diff</h2> <p>代码到这，基本上算是离成功有近了一大步，起码元素渲染出来了，但是光渲染可不是我们想要的结果，咱们是要修改他的数据，然后数据映射到<code>dom</code>节点上，前文说到过，可不能忙不的修改，咱得考虑一下性能的问题，比如弄个补丁包记录一下修改值？听起来很不错，说干就干,分许需求，拥有一个能计算出前后修改差异的<code>diff</code>函数来算出差别。我传入一个修改之前的<code>VertualDom</code>,然后载传入修改之后的<code>VertualDom2</code>,自动给我返回一个补丁包对象。用法如下！</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//index.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createElement<span class="token punctuation">,</span> render<span class="token punctuation">,</span> renderDom <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./element'</span>
<span class="token keyword">import</span> diff <span class="token keyword">from</span> <span class="token string">'./diff'</span>
<span class="token keyword">let</span> VertualDom <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;ul&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&quot;list&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&quot;itme&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&quot;itme&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&quot;itme&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> VertualDom2 <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;ul&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&quot;list-group&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&quot;itme&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&quot;itme&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&quot;itme&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> el <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span>VertualDom<span class="token punctuation">)</span>
<span class="token function">renderDom</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> window<span class="token punctuation">.</span>root<span class="token punctuation">)</span>
<span class="token keyword">let</span> patchs <span class="token operator">=</span> <span class="token function">diff</span><span class="token punctuation">(</span>VertualDom<span class="token punctuation">,</span> VertualDom2<span class="token punctuation">)</span>
</code></pre></div><p>看到用法，接下来根据需求来实现，老的节点与新的节点比较差异属性，首选递归，虽然容易出栈，但咱们就是试试，问题不大。其次，差异也分为其下几种展现形式</p> <ul><li>属性的差别
<ul><li>新增属性</li> <li>删除属性</li></ul></li> <li>节点的差别
<ul><li>新增节点</li> <li>删除节点</li> <li>替换节点</li></ul></li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//diff.js</span>
<span class="token keyword">function</span> <span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter">oldTree<span class="token punctuation">,</span> newTree</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> patches <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">//递归树，将比较的结果放入到补丁包中</span>
    <span class="token function">walk</span><span class="token punctuation">(</span>oldTree<span class="token punctuation">,</span> newTree<span class="token punctuation">,</span> index<span class="token punctuation">,</span> patches<span class="token punctuation">)</span>
    <span class="token keyword">return</span> patches<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>主函数来接收新旧节点，并且将索引值，补丁包对象传入来计算差异话,<code>walk</code>将递归dom结构来给修改的属性或节点存入补丁包</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//diff.js</span>
<span class="token comment">//递归树</span>
<span class="token keyword">const</span> <span class="token constant">ATTRS</span> <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">&quot;ATTRS&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token constant">TEXT</span> <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">&quot;TEXT&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token constant">REMOVE</span> <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">&quot;REMOVE&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token constant">REPLACE</span> <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">&quot;REPLACE&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> <span class="token constant">INDEX</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">walk</span><span class="token punctuation">(</span><span class="token parameter">oldNode<span class="token punctuation">,</span> newNode<span class="token punctuation">,</span> index<span class="token punctuation">,</span> patches</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> currentPatch <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//每个元素都默认一个补丁对象</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newNode<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//判断节点是否删除</span>
        currentPatch<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token constant">REMOVE</span><span class="token punctuation">,</span> index <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>oldNode<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isString</span><span class="token punctuation">(</span>newNode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//判断文本是否变化 判断 children 是否是文本</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldNode <span class="token operator">!==</span> newNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            currentPatch<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> text<span class="token operator">:</span> newNode <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldNode<span class="token punctuation">.</span>type <span class="token operator">===</span> newNode<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//属性</span>
        <span class="token comment">//比较属性是否更改 {1:a} =&gt; {1:a1}</span>
        <span class="token keyword">let</span> attrs <span class="token operator">=</span> <span class="token function">diffAttr</span><span class="token punctuation">(</span>oldNode<span class="token punctuation">.</span>props<span class="token punctuation">,</span> newNode<span class="token punctuation">.</span>props<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>attrs<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            currentPatch<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token constant">ATTRS</span><span class="token punctuation">,</span> attrs <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// if children </span>
        <span class="token function">diffchildren</span><span class="token punctuation">(</span>oldNode<span class="token punctuation">.</span>children<span class="token punctuation">,</span> newNode<span class="token punctuation">.</span>children<span class="token punctuation">,</span> patches<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//节点被替换掉</span>
        currentPatch<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token constant">REPLACE</span><span class="token punctuation">,</span> newNode <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentPatch<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//当前元素的确又补丁修改</span>
        patches<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> currentPatch
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>分析一下代码：上面的常量就不用解释了，<code>Symbol</code>只是确保完全的唯一性，<code>INDEX</code>全局的索引，避免递归产生索引错乱,公用<code>isString</code>用来判断是否是文本节点对象，可以看出判断一步一步来，首先如果删除节点，想对象中接入键值对来表示该请求的属性是啥，比如<code>{ type: TEXT, text: newNode }</code>,<code>type</code>是补丁包修改的属性,可能是<code>TEXT</code>，可能是属性<code>ATTR</code>,或者其他的标识，有利于后面遍历。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//判断children是否是字符串 --&gt; 字符串无法使用forEach</span>
<span class="token keyword">function</span> <span class="token function">isString</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'[object String]'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>比较属性的变化也是分为多种，新增删除或者修改，这里用了<code>diffAttr</code>来计算其差别，当然还有子节点比较<code>diffchildren</code>，当一切都是准别就绪是，一个计算补丁包的函数就搞定了，必需要确认的是最后一步<code>currentPatch.length &gt; 0</code>至少补丁包得修改了才能返回吧，要不然，动不动我没修改就调用方法，岂不是很坑。下面来分析一下计算比较属性的方法</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//比较属性</span>
<span class="token keyword">function</span> <span class="token function">diffAttr</span><span class="token punctuation">(</span><span class="token parameter">oldAttr<span class="token punctuation">,</span> newAttr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> patch <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">//判断新属性于老属性的关系</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> oldAttr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldAttr<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!==</span> newAttr<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//比较老属性与新属性 不相同就存新属性</span>
            patch<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> newAttr<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token comment">//有可能是undefined</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//判断是否是新增属性 老节点中没有新节点的属性</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> newAttr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldAttr<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            patch<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> newAttr<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> patch<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>无非就是分为两种情况</p> <ul><li>老属性被删除</li> <li>新属性增加
简单明了，有一点是可能会存在<code>undefined</code>这点小编暂时没有办法解决</li></ul> <p>再看一下分析子节点属性补丁包,使用递归简单明了</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">diffchildren</span><span class="token punctuation">(</span><span class="token parameter">oldChildren<span class="token punctuation">,</span> newChildren<span class="token punctuation">,</span> patches</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//比较老的第一个 和新的第一个</span>
    oldChildren<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">child<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//索引还是第一次比较的索引 会有问题 index每次传递的给walk都会递增一次</span>
        <span class="token function">walk</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">++</span><span class="token constant">INDEX</span><span class="token punctuation">,</span> patches<span class="token punctuation">)</span><span class="token comment">// 全局INDEX避免递归覆盖</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>齐活，上代码看差别</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//index.js</span>
<span class="token keyword">let</span> VertualDom <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;ul&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&quot;list&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&quot;itme&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&quot;itme&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&quot;itme&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> VertualDom2 <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;ul&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&quot;list-group&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&quot;itme&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&quot;itme&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&quot;itme&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> patchs <span class="token operator">=</span> <span class="token function">diff</span><span class="token punctuation">(</span>VertualDom<span class="token punctuation">,</span> VertualDom2<span class="token punctuation">)</span>
<span class="token comment">//给元素打补丁 重新更新视图</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>patchs<span class="token punctuation">)</span>
</code></pre></div><p><img src="/assets/img/react5.37bc729e.png" alt="react虚拟dom"></p> <h2 id="element替换节点的工匠patch"><a href="#element替换节点的工匠patch" class="header-anchor">#</a> element替换节点的工匠patch</h2> <p>有没有种自豪感，差别算出来了，接下来就是替换老节点了，将原有的<code>dom</code>置换掉，也是门技术活，说下思路，将打好标记的补丁包丢到函数内，遍历其中的区别属性，一次替换，性能不性能的先放一边，先以实现为主，期待用法</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//index.js</span>
<span class="token comment">//给元素打补丁 重新更新视图</span>
<span class="token keyword">let</span> el <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span>VertualDom<span class="token punctuation">)</span><span class="token comment">// 老节点</span>
<span class="token keyword">let</span> patchs <span class="token operator">=</span> <span class="token function">diff</span><span class="token punctuation">(</span>VertualDom<span class="token punctuation">,</span> VertualDom2<span class="token punctuation">)</span> <span class="token comment">// 更改之后的补丁包</span>
<span class="token function">patch</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> patchs<span class="token punctuation">)</span>
</code></pre></div><p>分析一下实现思路：遍历，循环，迭代,要不还是循环吧</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//patch.js</span>
<span class="token keyword">let</span> allPatches<span class="token punctuation">;</span>
<span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//默认哪个需要打补丁</span>

<span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> patches</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    allPatches <span class="token operator">=</span> patches
    <span class="token function">walk</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>主函数方法，全局存一个索引判断，避免出现污染状况</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//patch.js</span>
<span class="token comment">//补丁包</span>
<span class="token keyword">function</span> <span class="token function">walk</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> currentPatch <span class="token operator">=</span> allPatches<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> childNodes <span class="token operator">=</span> node<span class="token punctuation">.</span>childNodes<span class="token punctuation">;</span>
    childNodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span> <span class="token function">walk</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentPatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">doPatches</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> currentPatch<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>每一次循环都调用判断属性包的方法，并且得带其<code>children</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//patch.js</span>
<span class="token comment">//开始打补丁包</span>
<span class="token keyword">function</span> <span class="token function">doPatches</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> patches</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    patches<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">patch</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>patch<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token string">&quot;ATTRS&quot;</span><span class="token operator">:</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> patch<span class="token punctuation">.</span>attrs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">let</span> value <span class="token operator">=</span> patch<span class="token punctuation">.</span>attrs<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">setAttr</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        node<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">&quot;TEXT&quot;</span><span class="token operator">:</span>
                node<span class="token punctuation">.</span>textContent <span class="token operator">=</span> patch<span class="token punctuation">.</span>text<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">&quot;REMOVE&quot;</span><span class="token operator">:</span>
                node<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">&quot;REPLACE&quot;</span><span class="token operator">:</span>
                <span class="token keyword">let</span> newNode <span class="token operator">=</span> <span class="token punctuation">(</span>patch<span class="token punctuation">.</span>newNode <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token operator">?</span>
                    <span class="token function">render</span><span class="token punctuation">(</span>patch<span class="token punctuation">.</span>newNode<span class="token punctuation">)</span> <span class="token operator">:</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>patch<span class="token punctuation">.</span>newNode<span class="token punctuation">)</span>
                node<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>newNode<span class="token punctuation">,</span> node<span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>重点来了，将补丁包循环出来，这时候之前添加的<code>type</code>属性就派上用处了，<code>setAttr</code>也是之前的设置属性的方法，判断节点的时候需要过滤掉文本节点，文本与元素需要单独创建。至此，乞丐版的VirtualDom完工！也算是学习中的一点小笔记吧！</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">12/4/2019, 12:43:57 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/FAQ/ES/react-window.html" class="prev">
        🚕长列表
      </a></span> <span class="next"><a href="/FAQ/React/react-router.html">
        🍑router
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.903983bb.js" defer></script><script src="/assets/js/2.c5c844f9.js" defer></script><script src="/assets/js/7.b152462c.js" defer></script>
  </body>
</html>
